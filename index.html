<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proto Milk - Protocolo de tratamento (Online)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .selected-producer { background-color: #e0f2fe; border-left-color: #0ea5e9; }
        .tab-active { border-color: #2563eb; color: #2563eb; }
        .tab-inactive { border-color: transparent; color: #6b7280; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Proto Milk - Protocolo de tratamento</h1>
            <p class="text-gray-600 mt-2">Gerencie produtores, animais, medicamentos e tratamentos de forma simples.</p>
            <div id="status-indicator" class="mt-4 text-sm text-yellow-600 bg-yellow-100 p-2 rounded-lg"><p>Conectando à API...</p></div>
        </header>

        <!-- Abas de Navegação -->
        <div class="mb-8">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="tab-herds" type="button" class="tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Rebanho</button>
                    <button id="tab-meds" type="button" class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Medicamentos</button>
                    <button id="tab-treatments" type="button" class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Tratamentos</button>
                </nav>
            </div>
        </div>

        <!-- Painel Rebanho -->
        <main id="panel-herds" class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 bg-white p-6 rounded-2xl shadow-md">
                <h2 id="producer-form-title" class="text-2xl font-semibold mb-4">Adicionar Produtor</h2>
                <form id="add-producer-form" class="space-y-4 mb-6">
                    <input type="hidden" id="producer-id-edit">
                    <input type="text" id="producer-name" placeholder="Nome do Produtor" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    <input type="text" id="producer-property" placeholder="Nome da Propriedade" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    <input type="tel" id="producer-phone" placeholder="Telefone" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    <button id="producer-submit-btn" type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Adicionar Produtor</button>
                    <button id="producer-cancel-btn" type="button" class="w-full bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 hidden">Cancelar Edição</button>
                </form>
                <hr class="my-6">
                <h2 class="text-2xl font-semibold mb-4">Produtores Cadastrados</h2>
                <div id="producer-list-container" class="space-y-2"></div>
            </div>
            <div id="animals-section" class="lg:col-span-8 bg-white p-6 rounded-2xl shadow-md hidden">
                <h2 class="text-2xl font-semibold mb-4">Animais de <span id="selected-producer-name" class="text-blue-600"></span></h2>
                <details class="bg-gray-50 p-4 rounded-lg mb-6">
                    <summary class="font-semibold cursor-pointer text-lg">Cadastrar Novo Animal</summary>
                    <form id="add-animal-form" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="animal-id" placeholder="Nome ou Nº de Identificação" class="w-full px-4 py-2 border rounded-lg" required>
                        <input type="text" id="animal-breed" placeholder="Raça" class="w-full px-4 py-2 border rounded-lg" required>
                        <select id="animal-sex" class="w-full px-4 py-2 border rounded-lg" required><option value="" disabled selected>Selecione o Sexo</option><option value="Macho">Macho</option><option value="Fêmea">Fêmea</option></select>
                        <div class="flex items-center space-x-4"><label class="flex items-center"><input type="checkbox" id="animal-lactation" class="h-4 w-4 text-blue-600 rounded"><span class="ml-2">Em Lactação</span></label><label class="flex items-center"><input type="checkbox" id="animal-covered" class="h-4 w-4 text-blue-600 rounded"><span class="ml-2">Com Cobertura</span></label></div>
                        <input type="text" id="animal-mother" placeholder="Mãe do Animal (Nome/Nº)" class="w-full px-4 py-2 border rounded-lg">
                        <input type="text" id="animal-father" placeholder="Pai do Animal (Nome/Nº)" class="w-full px-4 py-2 border rounded-lg">
                        <button type="submit" class="md:col-span-2 w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">Salvar Animal</button>
                    </form>
                </details>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white"><thead class="bg-gray-100"><tr><th class="p-4 text-left text-xs font-medium uppercase">Identificação</th><th class="p-4 text-left text-xs font-medium uppercase">Raça</th><th class="p-4 text-left text-xs font-medium uppercase">Sexo</th><th class="p-4 text-left text-xs font-medium uppercase">Status</th><th class="p-4 text-left text-xs font-medium uppercase">Ações</th></tr></thead><tbody id="animal-list-container" class="divide-y"></tbody></table>
                </div>
                <p id="no-animals-message" class="text-center text-gray-500 py-8">Nenhum animal cadastrado.</p>
            </div>
            <div id="select-producer-prompt" class="lg:col-span-8 flex items-center justify-center bg-white p-6 rounded-2xl shadow-md"><div class="text-center"><svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg><h3 class="mt-2 text-lg font-medium">Selecione um produtor</h3><p class="mt-1 text-sm text-gray-500">Escolha um produtor para ver seus animais.</p></div></div>
        </main>

        <!-- Painel Medicamentos -->
        <main id="panel-meds" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 bg-white p-6 rounded-2xl shadow-md">
                <h2 id="med-form-title" class="text-2xl font-semibold mb-4">Cadastrar Medicamento</h2>
                <form id="add-med-form" class="space-y-4">
                    <input type="hidden" id="med-id-edit">
                    <input type="text" id="med-name" placeholder="Nome do Medicamento" class="w-full px-4 py-2 border rounded-lg" required>
                    <input type="number" id="med-dosage" placeholder="Dosagem (ml/kg)" step="0.1" class="w-full px-4 py-2 border rounded-lg" required>
                    <input type="number" id="med-withdrawal" placeholder="Carência Leite (dias)" class="w-full px-4 py-2 border rounded-lg" required>
                    <input type="number" id="med-price" placeholder="Valor (R$)" step="0.01" class="w-full px-4 py-2 border rounded-lg" required>
                    <div><label for="med-purchase-date" class="block text-sm font-medium">Data da Compra</label><input type="date" id="med-purchase-date" class="w-full px-4 py-2 border rounded-lg" required></div>
                    <div><label for="med-expiry" class="block text-sm font-medium">Data de Validade</label><input type="date" id="med-expiry" class="w-full px-4 py-2 border rounded-lg" required></div>
                    <button id="med-submit-btn" type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Adicionar Medicamento</button>
                    <button id="med-cancel-btn" type="button" class="w-full bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 hidden">Cancelar Edição</button>
                </form>
            </div>
            <div class="lg:col-span-8 bg-white p-6 rounded-2xl shadow-md">
                <h2 class="text-2xl font-semibold mb-4">Medicamentos Cadastrados</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white"><thead class="bg-gray-100"><tr><th class="p-4 text-left text-xs font-medium uppercase">Nome</th><th class="p-4 text-left text-xs font-medium uppercase">Dosagem</th><th class="p-4 text-left text-xs font-medium uppercase">Carência</th><th class="p-4 text-left text-xs font-medium uppercase">Valor</th><th class="p-4 text-left text-xs font-medium uppercase">Validade</th><th class="p-4 text-left text-xs font-medium uppercase">Ações</th></tr></thead><tbody id="med-list-container" class="divide-y"></tbody></table>
                </div>
                <p id="no-meds-message" class="text-center text-gray-500 py-8">Nenhum medicamento cadastrado.</p>
            </div>
        </main>
        
        <!-- Painel Tratamentos -->
        <main id="panel-treatments" class="hidden bg-white p-6 rounded-2xl shadow-md">
            <h2 class="text-2xl font-semibold mb-4">Animais em Tratamento (Período de Carência)</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white"><thead class="bg-gray-100"><tr><th class="p-4 text-left text-xs font-medium uppercase">Animal</th><th class="p-4 text-left text-xs font-medium uppercase">Produtor</th><th class="p-4 text-left text-xs font-medium uppercase">Motivo</th><th class="p-4 text-left text-xs font-medium uppercase">Medicamento</th><th class="p-4 text-left text-xs font-medium uppercase">Início</th><th class="p-4 text-left text-xs font-medium uppercase">Fim da Carência</th><th class="p-4 text-left text-xs font-medium uppercase">Ações</th></tr></thead><tbody id="treatment-list-container" class="divide-y"></tbody></table>
            </div>
            <p id="no-treatments-message" class="text-center text-gray-500 py-8">Nenhum animal em período de carência.</p>
        </main>
    </div>

    <!-- Modal Detalhes do Animal -->
    <div id="animal-details-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"><div class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white"><div class="flex justify-between items-center pb-3 border-b"><h3 id="modal-title" class="text-2xl font-bold">Detalhes do Animal</h3><button id="close-modal-btn" class="p-2 rounded-full hover:bg-gray-200">&times;</button></div><div id="modal-content" class="mt-3"></div></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = 'https://proto-milk-api.onrender.com';

            const statusIndicator = document.getElementById('status-indicator');
            let producersCache = [];
            let medicationsCache = [];

            // --- Camada de API ---
            const API = {
                request: async (endpoint, method = 'GET', body = null) => {
                    try {
                        const options = { method, headers: { 'Content-Type': 'application/json' } };
                        if (body) options.body = JSON.stringify(body);
                        const response = await fetch(`${API_URL}${endpoint}`, options);
                        if (!response.ok) throw new Error(`Erro na API: ${response.statusText}`);
                        if (response.status === 204) return;
                        return response.json();
                    } catch (error) {
                        console.error('Falha na comunicação com a API:', error);
                        statusIndicator.innerHTML = `<p class="text-red-600 bg-red-100 p-2 rounded-lg"><strong>Erro:</strong> Não foi possível conectar à API.</p>`;
                        return null;
                    }
                },
                getProducers: () => API.request('/producers'),
                addProducer: (p) => API.request('/producers', 'POST', p),
                updateProducer: (id, p) => API.request(`/producers/${id}`, 'PUT', p),
                deleteProducer: (id) => API.request(`/producers/${id}`, 'DELETE'),
                getAnimals: (id) => API.request(`/animals/${id}`),
                addAnimal: (a) => API.request('/animals', 'POST', a),
                updateAnimal: (id, a) => API.request(`/animals/${id}`, 'PUT', a),
                deleteAnimal: (id) => API.request(`/animals/${id}`, 'DELETE'),
                getMedications: () => API.request('/medications'),
                addMedication: (m) => API.request('/medications', 'POST', m),
                updateMedication: (id, m) => API.request(`/medications/${id}`, 'PUT', m),
                deleteMedication: (id) => API.request(`/medications/${id}`, 'DELETE'),
                getTreatments: () => API.request('/treatments'),
                addTreatment: (t) => API.request('/treatments', 'POST', t),
                deleteTreatment: (id) => API.request(`/treatments/${id}`, 'DELETE'),
            };

            // --- VARIÁVEIS DE ESTADO E ELEMENTOS DO DOM ---
            let selectedProducerId = null;

            const tabs = { herds: document.getElementById('tab-herds'), meds: document.getElementById('tab-meds'), treatments: document.getElementById('tab-treatments') };
            const panels = { herds: document.getElementById('panel-herds'), meds: document.getElementById('panel-meds'), treatments: document.getElementById('panel-treatments') };
            const producerForm = document.getElementById('add-producer-form');
            const producerFormTitle = document.getElementById('producer-form-title');
            const producerSubmitBtn = document.getElementById('producer-submit-btn');
            const producerCancelBtn = document.getElementById('producer-cancel-btn');
            const producerListContainer = document.getElementById('producer-list-container');
            const animalsSection = document.getElementById('animals-section');
            const selectedProducerNameEl = document.getElementById('selected-producer-name');
            const selectProducerPrompt = document.getElementById('select-producer-prompt');
            const addAnimalForm = document.getElementById('add-animal-form');
            const animalListContainer = document.getElementById('animal-list-container');
            const noAnimalsMessage = document.getElementById('no-animals-message');
            const medForm = document.getElementById('add-med-form');
            const medFormTitle = document.getElementById('med-form-title');
            const medSubmitBtn = document.getElementById('med-submit-btn');
            const medCancelBtn = document.getElementById('med-cancel-btn');
            const medListContainer = document.getElementById('med-list-container');
            const noMedsMessage = document.getElementById('no-meds-message');
            const treatmentListContainer = document.getElementById('treatment-list-container');
            const noTreatmentsMessage = document.getElementById('no-treatments-message');
            const animalDetailsModal = document.getElementById('animal-details-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const modalContent = document.getElementById('modal-content');
            const modalTitle = document.getElementById('modal-title');

            // --- FUNÇÕES DE RENDERIZAÇÃO ---
            const renderProducers = async () => {
                const producers = await API.getProducers();
                if (!producers) return;
                producersCache = producers;
                producerListContainer.innerHTML = producers.length === 0 ? '<p class="text-gray-500">Nenhum produtor cadastrado.</p>' : '';
                producers.forEach(p => {
                    const card = document.createElement('div');
                    card.className = `p-4 border-l-4 rounded-r-lg cursor-pointer hover:bg-gray-100 ${p.id === selectedProducerId ? 'selected-producer' : 'border-gray-200'}`;
                    card.dataset.id = p.id;
                    card.dataset.name = p.name;
                    card.innerHTML = `<div class="flex justify-between items-start"><div><h3 class="font-bold text-lg">${p.name}</h3><p class="text-sm text-gray-600">${p.property}</p><p class="text-sm text-gray-500">${p.phone}</p></div><div class="flex space-x-2"><button data-edit-id="${p.id}" class="edit-producer-btn text-gray-400 hover:text-blue-600 p-1 rounded-full">✏️</button><button data-delete-id="${p.id}" class="delete-producer-btn text-gray-400 hover:text-red-600 p-1 rounded-full">&times;</button></div></div>`;
                    producerListContainer.appendChild(card);
                });
            };

            const renderAnimals = async (producerId) => {
                const animals = await API.getAnimals(producerId);
                if (!animals) return;
                noAnimalsMessage.classList.toggle('hidden', animals.length > 0);
                animalListContainer.innerHTML = '';
                animals.forEach(a => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-gray-50";
                    let statusHtml = '';
                    if (a.sex === 'Fêmea') {
                        if (a.in_lactation) statusHtml += `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Lactação</span>`;
                        if (a.is_covered) statusHtml += `<span class="ml-2 px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Cobertura</span>`;
                    }
                    row.innerHTML = `<td class="p-4 cursor-pointer" data-animal-id="${a.id}"><div class="font-medium">${a.name_or_id}</div></td><td class="p-4 text-sm cursor-pointer" data-animal-id="${a.id}">${a.breed}</td><td class="p-4 text-sm cursor-pointer" data-animal-id="${a.id}">${a.sex}</td><td class="p-4 text-sm cursor-pointer" data-animal-id="${a.id}">${statusHtml || 'N/A'}</td><td class="p-4 text-sm"><button data-edit-animal-id="${a.id}" class="edit-animal-btn text-blue-600 hover:text-blue-900 mr-2">Editar</button><button data-delete-animal-id="${a.id}" class="delete-animal-btn text-red-600 hover:text-red-900">Excluir</button></td>`;
                    animalListContainer.appendChild(row);
                });
            };

            const renderMedications = async () => {
                const medications = await API.getMedications();
                if (!medications) return;
                medicationsCache = medications;
                noMedsMessage.classList.toggle('hidden', medications.length > 0);
                medListContainer.innerHTML = '';
                medications.forEach(m => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="p-4 font-medium">${m.name}</td><td class="p-4 text-sm">${m.dosage_per_kg} ml/kg</td><td class="p-4 text-sm">${m.milk_withdrawal_days} dias</td><td class="p-4 text-sm">R$ ${parseFloat(m.price).toFixed(2)}</td><td class="p-4 text-sm">${new Date(m.expiration_date).toLocaleDateString('pt-BR')}</td><td class="p-4 text-sm"><button data-edit-id="${m.id}" class="edit-med-btn text-blue-600 hover:text-blue-900 mr-2">Editar</button><button data-delete-med-id="${m.id}" class="delete-med-btn text-red-600 hover:text-red-900">Excluir</button></td>`;
                    medListContainer.appendChild(row);
                });
            };

            const renderTreatments = async () => {
                const treatments = await API.getTreatments();
                if (!treatments) return;
                // Para otimizar, o ideal seria o backend já trazer os nomes com JOINs.
                // Mas para manter simples, faremos as buscas aqui.
                const allAnimals = (await Promise.all(producersCache.map(p => API.getAnimals(p.id)))).flat();
                
                const activeTreatments = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                treatments.forEach(t => {
                    const startDate = new Date(t.start_date);
                    const withdrawalEndDate = new Date(startDate);
                    withdrawalEndDate.setDate(startDate.getDate() + t.milk_withdrawal_days);
                    if (withdrawalEndDate >= today) {
                        activeTreatments.push({ ...t, withdrawalEndDate });
                    }
                });

                noTreatmentsMessage.classList.toggle('hidden', activeTreatments.length > 0);
                treatmentListContainer.innerHTML = '';
                activeTreatments.forEach(t => {
                    const animal = allAnimals.find(a => a.id === t.animal_id);
                    const producer = animal ? producersCache.find(p => p.id === animal.producer_id) : null;
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="p-4 font-medium">${animal ? animal.name_or_id : 'N/A'}</td><td class="p-4 text-sm">${producer ? producer.name : 'N/A'}</td><td class="p-4 text-sm">${t.reason}</td><td class="p-4 text-sm">${t.medication_name}</td><td class="p-4 text-sm">${new Date(t.start_date).toLocaleDateString('pt-BR')}</td><td class="p-4 text-sm font-semibold text-red-600">${t.withdrawalEndDate.toLocaleDateString('pt-BR')}</td><td class="p-4 text-sm"><button data-treatment-id="${t.id}" class="finish-treatment-btn bg-green-500 text-white px-3 py-1 rounded-md hover:bg-green-600 text-xs">Finalizar</button></td>`;
                    treatmentListContainer.appendChild(row);
                });
            };

            // --- LÓGICA DE EVENTOS ---
            function switchTab(activeTab) {
                for (const key in tabs) {
                    const is_active = key === activeTab;
                    tabs[key].classList.toggle('tab-active', is_active);
                    tabs[key].classList.toggle('tab-inactive', !is_active);
                    if (panels[key]) panels[key].classList.toggle('hidden', !is_active);
                }
            }
            tabs.herds.addEventListener('click', () => switchTab('herds'));
            tabs.meds.addEventListener('click', () => switchTab('meds'));
            tabs.treatments.addEventListener('click', async () => {
                switchTab('treatments');
                await renderTreatments();
            });

            // Produtor Events
            producerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('producer-id-edit').value;
                const producerData = { name: document.getElementById('producer-name').value, property: document.getElementById('producer-property').value, phone: document.getElementById('producer-phone').value };
                if (id) await API.updateProducer(id, producerData);
                else await API.addProducer(producerData);
                resetProducerForm();
                await renderProducers();
            });

            producerListContainer.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-producer-btn');
                const editBtn = e.target.closest('.edit-producer-btn');
                const card = e.target.closest('[data-id]');
                if (deleteBtn) {
                    e.stopPropagation();
                    if (confirm('Tem certeza? Isso excluirá também todos os animais deste produtor.')) {
                        await API.deleteProducer(deleteBtn.dataset.deleteId);
                        if (selectedProducerId == deleteBtn.dataset.deleteId) {
                            selectedProducerId = null;
                            animalsSection.classList.add('hidden');
                            selectProducerPrompt.classList.remove('hidden');
                        }
                        await renderProducers();
                    }
                } else if (editBtn) {
                    e.stopPropagation();
                    const producer = producersCache.find(p => p.id == editBtn.dataset.editId);
                    document.getElementById('producer-id-edit').value = producer.id;
                    document.getElementById('producer-name').value = producer.name;
                    document.getElementById('producer-property').value = producer.property;
                    document.getElementById('producer-phone').value = producer.phone;
                    producerFormTitle.textContent = "Editar Produtor";
                    producerSubmitBtn.textContent = "Salvar Alterações";
                    producerSubmitBtn.classList.replace('bg-blue-600', 'bg-green-600');
                    producerCancelBtn.classList.remove('hidden');
                } else if (card) {
                    selectedProducerId = parseInt(card.dataset.id);
                    selectedProducerNameEl.textContent = card.dataset.name;
                    animalsSection.classList.remove('hidden');
                    selectProducerPrompt.classList.add('hidden');
                    await renderProducers();
                    await renderAnimals(selectedProducerId);
                }
            });
            
            function resetProducerForm() {
                producerForm.reset();
                document.getElementById('producer-id-edit').value = '';
                producerFormTitle.textContent = "Adicionar Produtor";
                producerSubmitBtn.textContent = "Adicionar Produtor";
                producerSubmitBtn.classList.replace('bg-green-600', 'bg-blue-600');
                producerCancelBtn.classList.add('hidden');
            }
            producerCancelBtn.addEventListener('click', resetProducerForm);

            // Animal Events
            addAnimalForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!selectedProducerId) return;
                const animalData = {
                    producer_id: selectedProducerId,
                    name_or_id: document.getElementById('animal-id').value,
                    breed: document.getElementById('animal-breed').value,
                    sex: document.getElementById('animal-sex').value,
                    in_lactation: document.getElementById('animal-lactation').checked,
                    is_covered: document.getElementById('animal-covered').checked,
                    mother_id: document.getElementById('animal-mother').value,
                    father_id: document.getElementById('animal-father').value,
                };
                await API.addAnimal(animalData);
                addAnimalForm.reset();
                addAnimalForm.closest('details').removeAttribute('open');
                await renderAnimals(selectedProducerId);
            });

            animalListContainer.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-animal-btn');
                const editBtn = e.target.closest('.edit-animal-btn');
                const cell = e.target.closest('td[data-animal-id]');
                if (deleteBtn) {
                    e.stopPropagation();
                    if (confirm('Tem certeza?')) {
                        await API.deleteAnimal(deleteBtn.dataset.deleteAnimalId);
                        await renderAnimals(selectedProducerId);
                    }
                } else if (editBtn) {
                    e.stopPropagation();
                    const animals = await API.getAnimals(selectedProducerId);
                    const animal = animals.find(a => a.id == editBtn.dataset.editAnimalId);
                    showAnimalDetails(animal, true);
                } else if (cell) {
                    const animals = await API.getAnimals(selectedProducerId);
                    const animal = animals.find(a => a.id == cell.dataset.animalId);
                    showAnimalDetails(animal, false);
                }
            });

            // Medicamento Events
            // ... (A lógica de edição e deleção de medicamentos seguiria o mesmo padrão dos produtores)

            // Tratamento Events
            treatmentListContainer.addEventListener('click', async (e) => {
                const finishBtn = e.target.closest('.finish-treatment-btn');
                if (finishBtn) {
                    if (confirm('Tem certeza que deseja finalizar este tratamento?')) {
                        await API.deleteTreatment(finishBtn.dataset.treatmentId);
                        await renderTreatments();
                    }
                }
            });

            // Modal Logic
            function showAnimalDetails(animal, isEditMode = false) {
                // A lógica do modal é a mesma da versão offline,
                // com a diferença que a chamada para salvar (DB.updateAnimal ou DB.addTreatment)
                // deve ser trocada por `await API.updateAnimal` ou `await API.addTreatment`.
            }
            closeModalBtn.addEventListener('click', () => animalDetailsModal.classList.add('hidden'));

            // --- INICIALIZAÇÃO ---
            const initializeApp = async () => {
                const testConnection = await API.request('/');
                if (testConnection !== null) {
                     statusIndicator.innerHTML = `<p class="text-green-600 bg-green-100 p-2 rounded-lg"><strong>Modo Online:</strong> Conectado com sucesso!</p>`;
                }
                
                await renderProducers();
                await renderMedications();
                // await renderTreatments(); // Chamado ao clicar na aba
            };

            initializeApp();
        });
    </script>
</body>
</html>
